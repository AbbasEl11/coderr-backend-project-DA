version: '3.8'

services:
  # Django Backend API
  backend:
    image: myhomies.cr.de-fra.ionos.com/abbas/coderr-backend:latest
    container_name: coderr-backend
    command: gunicorn --bind 0.0.0.0:8000 --workers 3 --timeout 120 core.wsgi:application
    volumes:
      - sqlite_data:/app/data
      - static_volume:/app/staticfiles
      - media_volume:/app/mediafiles
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-False}
      - ALLOWED_HOSTS=coderr.abbas-el-mahmoud.com,coderrapi.abbas-el-mahmoud.com,localhost,127.0.0.1
      - CORS_ALLOWED_ORIGINS=https://coderr.abbas-el-mahmoud.com
      - CSRF_TRUSTED_ORIGINS=https://coderr.abbas-el-mahmoud.com,https://coderrapi.abbas-el-mahmoud.com
      - DJANGO_SUPERUSER_USERNAME=${DJANGO_SUPERUSER_USERNAME:-admin}
      - DJANGO_SUPERUSER_EMAIL=${DJANGO_SUPERUSER_EMAIL:-admin@example.com}
      - DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD}
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_proxy
      - traefik.http.routers.coderr-backend.rule=Host(`coderrapi.abbas-el-mahmoud.com`) && !PathPrefix(`/media`)
      - traefik.http.routers.coderr-backend.entrypoints=websecure
      - traefik.http.routers.coderr-backend.tls.certresolver=leresolver
      - traefik.http.services.coderr-backend.loadbalancer.server.port=8000
    networks:
      - default
      - traefik_proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/admin/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Application
  frontend:
    image: nginx:alpine
    container_name: coderr-frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./frontend-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_proxy
      - traefik.http.routers.coderr-frontend.rule=Host(`coderr.abbas-el-mahmoud.com`)
      - traefik.http.routers.coderr-frontend.entrypoints=websecure
      - traefik.http.routers.coderr-frontend.tls.certresolver=leresolver
      - traefik.http.services.coderr-frontend.loadbalancer.server.port=80
      # Frontend hat Priorität für Root-Pfad
      - traefik.http.routers.coderr-frontend.priority=1
    networks:
      - default
      - traefik_proxy
    restart: unless-stopped
    depends_on:
      - backend
      
  media:
    image: nginx:alpine
    container_name: coderr-media
    volumes:
      - media_volume:/media:ro
      - ./media-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_proxy

      - traefik.http.routers.coderr-media.rule=Host(`coderrapi.abbas-el-mahmoud.com`) && PathPrefix(`/media`)
      - traefik.http.routers.coderr-media.entrypoints=websecure
      - traefik.http.routers.coderr-media.tls.certresolver=leresolver
      - traefik.http.routers.coderr-media.priority=10
      - traefik.http.middlewares.coderr-media-strip.stripprefix.prefixes=/media
      - traefik.http.routers.coderr-media.middlewares=coderr-media-strip
      - traefik.http.services.coderr-media.loadbalancer.server.port=80
    networks:
      - traefik_proxy
    restart: unless-stopped   

networks:
  traefik_proxy:
    external: true
  default:
    driver: bridge

volumes:
  sqlite_data:
  static_volume:
  media_volume:
